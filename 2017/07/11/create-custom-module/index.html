<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="drupal8," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="理解Examples module, Symfony, Controllers, and the MenuBlocks, Configuration, and FormsConfiguration forms and managementConfiguration management提供一个集中的地方来存储configuration数据，可以在多个环境建导入导出配置信息。Config Objec">
<meta name="keywords" content="drupal8">
<meta property="og:type" content="article">
<meta property="og:title" content="create custom module">
<meta property="og:url" content="http://yoursite.com/2017/07/11/create-custom-module/index.html">
<meta property="og:site_name" content="Ly&#39;s cheat sheet">
<meta property="og:description" content="理解Examples module, Symfony, Controllers, and the MenuBlocks, Configuration, and FormsConfiguration forms and managementConfiguration management提供一个集中的地方来存储configuration数据，可以在多个环境建导入导出配置信息。Config Objec">
<meta property="og:image" content="http://yoursite.com/2017/07/11/create-custom-module/1.png">
<meta property="og:image" content="http://yoursite.com/2017/07/11/create-custom-module/2.png">
<meta property="og:updated_time" content="2017-07-19T08:13:37.809Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="create custom module">
<meta name="twitter:description" content="理解Examples module, Symfony, Controllers, and the MenuBlocks, Configuration, and FormsConfiguration forms and managementConfiguration management提供一个集中的地方来存储configuration数据，可以在多个环境建导入导出配置信息。Config Objec">
<meta name="twitter:image" content="http://yoursite.com/2017/07/11/create-custom-module/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/07/11/create-custom-module/"/>





  <title>create custom module | Ly's cheat sheet</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ly's cheat sheet</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/11/create-custom-module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="beBetterLy@126.com">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ly's cheat sheet">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">create custom module</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-11T13:56:33+08:00">
                2017-07-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="理解"><a href="#理解" class="headerlink" title="理解"></a>理解</h1><p><a href="https://docs.acquia.com/articles/examples-module-symfony-controllers-and-menu" target="_blank" rel="external">Examples module, Symfony, Controllers, and the Menu</a><br><a href="https://docs.acquia.com/articles/drupal-8-blocks-configuration-and-forms" target="_blank" rel="external">Blocks, Configuration, and Forms</a><br><a href="https://docs.acquia.com/article/lesson-31-configuration-forms-and-management" target="_blank" rel="external">Configuration forms and management</a><br>Configuration management提供一个集中的地方来存储configuration数据，可以在多个环境建导入导出配置信息。<br>Config Object是configuration的一个实例。<br>Configuration form是一个特殊的form，用来帮助存储configuration数据到数据库或文件。<br>enable module的时候，config/install/module_name.settings.yml中定义的数据会被导入到数据库中，在这之后，如果db中configuration数据发生变化的话，可以使用export/import在各个环境间导出/导入configuration数据。<br><img src="/2017/07/11/create-custom-module/1.png" alt="1.png" title=""><br>config/install/config_form_example.settings.yml中定义的是实际操作的字段键值对，最后都会存储到db config表中。<br>config/schema/config_form_example.schema.yml中定义的是实际操作的字段的定义。<br><img src="/2017/07/11/create-custom-module/2.png" alt="2.png" title=""><br><a href="https://docs.acquia.com/article/lesson-41-entities-content-entities-and-configuration-entities" target="_blank" rel="external">Entities, Content Entities, and Configuration Entities</a></p>
<ol>
<li>概念</li>
</ol>
<ul>
<li>Entity types:<br>An entity type is a useful abstraction to group together fields.</li>
<li>Bundles:<br>Bundles are an implementation of an entity type to which fields can be attached. You can consider bundles as subtypes of an entity type.</li>
<li>Fields:<br>A field is a reusable piece of content. In technical terms, each field is a primitive data type, with custom validators and widgets for editing and formatters for display.</li>
<li>Entity :<br>An entity would be one instance of a particular entity type such as a comment, taxonomy term or user profile or of a bundle such as a blog post, article or product.<br>An entity that are used for persistent storage of content and configuration information.</li>
</ul>
<p>Putting this in Object-Oriented Design<br>・An entity type is a base class<br>・A bundle is an extended class<br>・A field is a class member, property, variable or field instance (depending on your naming preference)<br>・An entity is an object or instance of a base or extended class</p>
<ul>
<li>Content:<br>Information meant to be displayed on your site: articles, basic pages, images, files, custom blocks, etc.  This type of information tends to be relatively permanent, but can normally be edited.</li>
<li>Content entity:<br>A content entity (or more commonly, entity) is an item of content data, which can consist of text, HTML markup, images, attached files, and other data that is intended to be displayed to site visitors.</li>
<li>Configuration:<br>Information about your site that is not content, but is also relatively permanent, and is used to define how your site behaves or is displayed. It is sometimes also displayed to site visitors, but tends to be smaller pieces of text (like field labels, the name of your site, etc.) , the content types and views you have defined  rather than larger chunks that you’d normally think of as Content.</li>
<li>Configuration entities:<br>Drupal 8 introduces the concept of configuration entities (or configurables) that leverage the entity system’s CRUD and pluggable storage functionality. The main difference between configuration entities and Drupal 7-style content entities is that configuration entities use the configuration system for storage, rather than the database. They differ from plain configuration in that they are typically user-created, and often need to fire and respond to hooks. Examples of potential configuration entities include:<br>Content types<br>Views<br>Taxonomy vocabularies<br>Contact forms<br>Image styles</li>
</ul>
<ol>
<li>Configuration Entity Differences compared to Content Entity<br>Integrates with CMI API for exportability<br>No fields<br>Schema file (Content Entity uses hook_schema())</li>
<li>相关整理<br>所有entity_type<br><a href="https://www.drupal.org/files/classDrupal_Entities.png" target="_blank" rel="external">https://www.drupal.org/files/classDrupal_Entities.png</a><br>经常用到的content entities的方法，类，接口的备忘<br><a href="https://wizzlern.nl/sites/wizzlern.nl/files/artikel/drupal-content-entity-8.0.pdf" target="_blank" rel="external">https://wizzlern.nl/sites/wizzlern.nl/files/artikel/drupal-content-entity-8.0.pdf</a><br>几种实体类型的实际应用<br><a href="https://www.drupal.org/docs/user_guide/en/planning-data-types.html" target="_blank" rel="external">https://www.drupal.org/docs/user_guide/en/planning-data-types.html</a></li>
<li>drupal提供的entity可以做任何事，为什么还需要自定义entity_type?<br>只有性能敏感的项目需要自定义entity_type<br><a href="http://www.trellon.com/content/blog/creating-own-entities-entity-api" target="_blank" rel="external">http://www.trellon.com/content/blog/creating-own-entities-entity-api</a></li>
</ol>
<p><a href="https://docs.acquia.com/articles/drupal-8-entity-queries-and-loading-entities" target="_blank" rel="external">Entity queries and loading entities</a></p>
<ul>
<li>entity query</li>
</ul>
<ol>
<li><p>Class based method (recommended)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// This function and the next are part of the dependency injection pattern. We will explain those in future chapters.</div><div class="line">public function __construct(QueryFactory $entity_query) &#123;</div><div class="line">  $this-&gt;entity_query = $entity_query;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static function create(ContainerInterface $container) &#123;</div><div class="line">  return new static(</div><div class="line">    // User the $container to get a query factory object. This object lets us create query objects.</div><div class="line">    $container-&gt;get(&apos;entity.query&apos;)</div><div class="line">  );</div><div class="line">&#125;</div><div class="line"></div><div class="line">// This function shows how to</div><div class="line">public function myCallback() &#123;</div><div class="line">  // Use the factory to create a query object for node entities.</div><div class="line">  $query = $this-&gt;entity_query-&gt;get(&apos;node&apos;);</div><div class="line"></div><div class="line">  // Add a filter (published).</div><div class="line">  $query-&gt;condition(&apos;status&apos;, 1);</div><div class="line"></div><div class="line">  // Run the query.</div><div class="line">  $nids = $query-&gt;execute();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Static method (not recommended)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$query = \Drupal::entityQuery(&apos;node&apos;);</div></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>entity loading</li>
</ul>
<ol>
<li><p>Class method (recommended)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">protected $entity_manager;</div><div class="line"></div><div class="line">public function __construct(EntityTypeManagerInterface $entity_manager) &#123;</div><div class="line">    $this-&gt;entity_manager = $entity_manager;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static function create(ContainerInterface $container) &#123;</div><div class="line">    return new static(</div><div class="line">        $container-&gt;get(&apos;entity_type.manager&apos;)</div><div class="line">    );</div><div class="line">&#125;</div><div class="line"></div><div class="line">public function load() &#123;</div><div class="line">    $node_storage = $this-&gt;entity_manager-&gt;getStorage(&apos;node&apos;);</div><div class="line">    $nid = 1;</div><div class="line">    $node = $node_storage-&gt;load($nid);</div><div class="line">    return [</div><div class="line">        &apos;#markup&apos; =&gt; $node-&gt;get(&apos;title&apos;)-&gt;value,</div><div class="line">    ];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Static method (not recommended)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// Get a node storage object.</div><div class="line">$node_storage = \Drupal::entityManager()-&gt;getStorage(&apos;node&apos;);</div><div class="line"></div><div class="line">// Load a single node.</div><div class="line">$node_storage-&gt;load($nid);</div></pre></td></tr></table></figure>
</li>
<li><p>Global method (not recommended)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// Load a single entity.</div><div class="line">$node = entity_load(&apos;node&apos;, $nid);</div></pre></td></tr></table></figure>
</li>
<li><p>special class method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$node = Node::load($nid);</div></pre></td></tr></table></figure>
</li>
</ol>
<p><a href="https://wizzlern.nl/sites/wizzlern.nl/files/artikel/drupal-content-entity-8.0.pdf" target="_blank" rel="external">Entity Query cheatsheet</a></p>
<h2 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h2><h3 id="最小化实现"><a href="#最小化实现" class="headerlink" title="最小化实现"></a>最小化实现</h3><ol>
<li>.info.yml</li>
<li>src/Plugin/Block/ExampleEmptyBlock.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Provides a &apos;Example: empty block&apos; block.</div><div class="line"> *</div><div class="line"> * @Block(</div><div class="line"> *   id = &quot;example_empty&quot;,</div><div class="line"> *   admin_label = @Translation(&quot;Example: empty block&quot;)</div><div class="line"> * )</div><div class="line"> */</div><div class="line">class ExampleEmptyBlock extends BlockBase &#123;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * &#123;@inheritdoc&#125;</div><div class="line">   */</div><div class="line">  public function build() &#123;</div><div class="line">    // We return an empty array on purpose. The block will thus not be rendered</div><div class="line">    // on the site. See BlockExampleTest::testBlockExampleBasic().</div><div class="line">    return array(&apos;#markup&apos; =&gt; t(&apos;empty block&apos;));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><h4 id="Create-a-block-which-displays-a-rotating-banner-of-images-Block-configuration"><a href="#Create-a-block-which-displays-a-rotating-banner-of-images-Block-configuration" class="headerlink" title="Create a block which displays a rotating banner of images.(Block configuration)"></a>Create a block which displays a rotating banner of images.(Block configuration)</h4><ol>
<li>.info.yml</li>
<li><p>rotate_image_block.module</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">* Implements hook_theme().</div><div class="line">*/</div><div class="line">function rotate_image_block_theme($existing, $type, $theme, $path) &#123;</div><div class="line">  return array(</div><div class="line">      &apos;rotate_image_block&apos; =&gt; array(</div><div class="line">          &apos;variables&apos; =&gt; array(&apos;image_path&apos; =&gt; NULL),</div><div class="line">          &apos;template&apos; =&gt; &apos;rotate-image-block&apos;,</div><div class="line">      ),</div><div class="line">  );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>templates/rotate-image-block.html.twig</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;img class=&quot;rotate&quot; src=&quot;&#123;&#123; image_path &#125;&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>src/Plugin/Block/RotateImageBlock.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">namespace Drupal\rotate_image_block\Plugin\Block;</div><div class="line"></div><div class="line">use Drupal\Core\Block\BlockBase;</div><div class="line">use Drupal\Core\Form\FormStateInterface;</div><div class="line">use Drupal\file\Entity\File;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Provides a &apos;Example: configurable text string&apos; block.</div><div class="line"> *</div><div class="line"> * Drupal\Core\Block\BlockBase gives us a very useful set of basic functionality</div><div class="line"> * for this configurable block. We can just fill in a few of the blanks with</div><div class="line"> * defaultConfiguration(), blockForm(), blockSubmit(), and build().</div><div class="line"> *</div><div class="line"> * @Block(</div><div class="line"> *   id = &quot;rotate_image_block&quot;,</div><div class="line"> *   admin_label = @Translation(&quot;Rotate image&quot;)</div><div class="line"> * )</div><div class="line"> */</div><div class="line">class RotateImageBlock extends BlockBase &#123;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * &#123;@inheritdoc&#125;</div><div class="line">   */</div><div class="line">  public function blockForm($form, FormStateInterface $form_state) &#123;</div><div class="line">    $form[&apos;icon_upload&apos;] = array(</div><div class="line">      &apos;#type&apos; =&gt; &apos;managed_file&apos;,</div><div class="line">      &apos;#title&apos; =&gt; $this-&gt;t(&apos;Icon image&apos;),</div><div class="line">      &apos;#description&apos; =&gt; $this-&gt;t(&apos;If you\&apos;d like an image to display next to this menu item, upload it here.&apos;),</div><div class="line">        &apos;#upload_validators&apos;  =&gt; array(</div><div class="line">            &apos;file_validate_extensions&apos; =&gt; array(&apos;gif png jpg jpeg svg&apos;),</div><div class="line">        ),</div><div class="line">       &apos;#upload_location&apos; =&gt; &apos;public://menu_icons/&apos;,</div><div class="line">        &apos;#default_value&apos; =&gt; [&quot;3&quot;],</div><div class="line">    );</div><div class="line">    return $form;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * &#123;@inheritdoc&#125;</div><div class="line">   */</div><div class="line">  public function blockSubmit($form, FormStateInterface $form_state) &#123;</div><div class="line">      // First we just grab the file ID for the icon we uploaded, if any.</div><div class="line">      $icon_field = $form_state-&gt;getValue(&apos;icon_upload&apos;);</div><div class="line">      $file_id = empty($icon_field) ? FALSE : reset($icon_field);</div><div class="line"></div><div class="line">      if (!empty($file_id)) &#123;</div><div class="line">          // Make this a permanent file so that cron doesn&apos;t delete it later.</div><div class="line">          $file = File::load($file_id);</div><div class="line">          $file-&gt;status = FILE_STATUS_PERMANENT;</div><div class="line">          $file-&gt;save();</div><div class="line"></div><div class="line">          // Grab the image&apos;s path for referencing it as a background image.</div><div class="line">          $image_path = $file-&gt;getFileUri();</div><div class="line"></div><div class="line">          $path = file_url_transform_relative(file_create_url($image_path));</div><div class="line">          $this-&gt;configuration[&apos;image_path&apos;] = $path;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /**</div><div class="line">   * &#123;@inheritdoc&#125;</div><div class="line">   */</div><div class="line">  public function build() &#123;</div><div class="line">    return array(</div><div class="line">      &apos;#theme&apos; =&gt; &apos;rotate_image_block&apos;,</div><div class="line">      &apos;#image_path&apos; =&gt; $this-&gt;configuration[&apos;image_path&apos;],</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="Create-a-form-block-which-can-send-an-e-mail-to-an-address-provided-in-the-form-block-form"><a href="#Create-a-form-block-which-can-send-an-e-mail-to-an-address-provided-in-the-form-block-form" class="headerlink" title="Create a form block which can send an e-mail to an address provided in the form. (block form)"></a>Create a form block which can send an e-mail to an address provided in the form. (block form)</h4><ol>
<li>.info.yml</li>
<li><p>src/Form/SimpleForm.php<br>定义Form，用来输入email</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">  public function buildForm(array $form, FormStateInterface $form_state) &#123;</div><div class="line"></div><div class="line">    $form[&apos;email&apos;] = [</div><div class="line">      &apos;#type&apos; =&gt; &apos;email&apos;,</div><div class="line">      &apos;#title&apos; =&gt; $this-&gt;t(&apos;email&apos;),</div><div class="line">      &apos;#description&apos; =&gt; $this-&gt;t(&apos;Title must be a valid email address.&apos;),</div><div class="line">      &apos;#required&apos; =&gt; TRUE,</div><div class="line">    ];</div><div class="line"></div><div class="line">    // Group submit handlers in an actions element with a key of &quot;actions&quot; so</div><div class="line">    // that it gets styled correctly, and so that other modules may add actions</div><div class="line">    // to the form. This is not required, but is convention.</div><div class="line">    $form[&apos;actions&apos;] = [</div><div class="line">      &apos;#type&apos; =&gt; &apos;actions&apos;,</div><div class="line">    ];</div><div class="line"></div><div class="line">    // Add a submit button that handles the submission of the form.</div><div class="line">    $form[&apos;actions&apos;][&apos;submit&apos;] = [</div><div class="line">      &apos;#type&apos; =&gt; &apos;submit&apos;,</div><div class="line">      &apos;#value&apos; =&gt; $this-&gt;t(&apos;Submit&apos;),</div><div class="line">    ];</div><div class="line"></div><div class="line">    return $form;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  public function getFormId() &#123;</div><div class="line">    return &apos;send_email_block_simple_form&apos;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  public function submitForm(array &amp;$form, FormStateInterface $form_state) &#123;</div><div class="line">    /*</div><div class="line">     * This would normally be replaced by code that actually does something</div><div class="line">     * with the title.</div><div class="line">     */</div><div class="line">    $email = $form_state-&gt;getValue(&apos;email&apos;);</div><div class="line"></div><div class="line">      $newMail = \Drupal::service(&apos;plugin.manager.mail&apos;);</div><div class="line">      $params[&apos;email&apos;] = $email;</div><div class="line">      $newMail-&gt;mail(&apos;send_email_block&apos;, &apos;send_email&apos;, $email, &apos;en&apos;, $params, $reply = NULL, $send = TRUE);</div><div class="line">      drupal_set_message(&apos;Mail has been sent.&apos;, &apos;status&apos;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>src/Plugin/Block/SendEmailBlock.php<br>render SimpleForm到block</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public function build() &#123;</div><div class="line">  $form = \Drupal::formBuilder()-&gt;getForm(&apos;Drupal\send_email_block\Form\SimpleForm&apos;);</div><div class="line">  return $form;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>send_email_block.module<br>实现hook_mail构建mail内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">function send_email_block_mail($key, &amp;$message, $params) &#123;</div><div class="line"></div><div class="line">    // E-mail formatting will be exactly as below, so do not use indenting!</div><div class="line">    $body =</div><div class="line">        &quot;Hi,</div><div class="line"></div><div class="line">I&apos;m just showing off my work ...</div><div class="line">Works nicely huh?</div><div class="line">Should probably add a password here somewhere?</div><div class="line"></div><div class="line">Your username: &quot; . $params[&apos;email&apos;] . &quot;</div><div class="line"></div><div class="line">See ya!&quot;;</div><div class="line"></div><div class="line">    $message[&apos;subject&apos;] = &quot;Exercise account registration&quot;;</div><div class="line">    $message[&apos;body&apos;][] = Drupal\Core\Mail\MailFormatHelper::htmlToText($body);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>发送mail方法参照<a href="../../13/send-mail/index.html">这里</a></p>
<h2 id="Configuration-forms"><a href="#Configuration-forms" class="headerlink" title="Configuration forms"></a>Configuration forms</h2><ol>
<li>config_form_example.info.yml</li>
<li><p>config/install/config_form_example.settings.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">email_address: form@examples.com</div></pre></td></tr></table></figure>
</li>
<li><p>src/Form/ConfigFormExampleConfigForm.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * &#123;@inheritdoc&#125;.</div><div class="line">    */</div><div class="line">   public function getFormId() &#123;</div><div class="line">       return &apos;config_form_example_form&apos;;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * &#123;@inheritdoc&#125;.</div><div class="line">    */</div><div class="line">   public function buildForm(array $form, FormStateInterface $form_state) &#123;</div><div class="line">       $form = parent::buildForm($form, $form_state);</div><div class="line">       $config = $this-&gt;config(&apos;config_form_example.settings&apos;);</div><div class="line">       $form[&apos;email&apos;] = [</div><div class="line">           &apos;#type&apos; =&gt; &apos;email&apos;,</div><div class="line">           &apos;#title&apos; =&gt; $this-&gt;t(&apos;Your .com email address.&apos;),</div><div class="line">           &apos;#default_value&apos; =&gt; $config-&gt;get(&apos;email_address&apos;),</div><div class="line">       ];</div><div class="line">       return $form;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * &#123;@inheritdoc&#125;</div><div class="line">    */</div><div class="line">   public function validateForm(array &amp;$form, FormStateInterface $form_state) &#123;</div><div class="line">       if (strpos($form_state-&gt;getValue(&apos;email&apos;), &apos;.com&apos;) === FALSE ) &#123;</div><div class="line">           $form_state-&gt;setErrorByName(&apos;email&apos;, $this-&gt;t(&apos;This is not a .com email address.&apos;));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * &#123;@inheritdoc&#125;</div><div class="line">    */</div><div class="line">   public function submitForm(array &amp;$form, FormStateInterface $form_state) &#123;</div><div class="line">       $config = $this-&gt;config(&apos;config_form_example.settings&apos;);</div><div class="line">       $config-&gt;set(&apos;email_address&apos;, $form_state-&gt;getValue(&apos;email&apos;));</div><div class="line">       $config-&gt;save();</div><div class="line">       return parent::submitForm($form, $form_state);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * &#123;@inheritdoc&#125;</div><div class="line">    */</div><div class="line">   protected function getEditableConfigNames() &#123;</div><div class="line">       return [&apos;config_form_example.settings&apos;];</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>config_form_example.routing.yml</p>
</li>
<li>config/schema/config_form_example.schema.yml (optional)</li>
</ol>
<h1 id="hooks"><a href="#hooks" class="headerlink" title="hooks"></a>hooks</h1><h2 id="hook-help"><a href="#hook-help" class="headerlink" title="hook_help"></a><a href="https://api.drupal.org/api/drupal/core%21modules%21help%21help.api.php/function/hook_help/8.3.x" target="_blank" rel="external">hook_help</a></h2><p>修改输出帮助信息。</p>
<ol>
<li>module help</li>
<li>指定页面help</li>
</ol>
<h2 id="hook-toolbar"><a href="#hook-toolbar" class="headerlink" title="hook_toolbar"></a><a href="https://api.drupal.org/api/drupal/core%21modules%21toolbar%21toolbar.api.php/function/hook_toolbar/8.2.x" target="_blank" rel="external">hook_toolbar</a></h2><p>添加item到toolbar容器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$items[&apos;commerce&apos;] = array(</div><div class="line"> &apos;#type&apos; =&gt; &apos;toolbar_item&apos;,</div><div class="line"> &apos;tab&apos; =&gt; array(</div><div class="line">   &apos;#type&apos; =&gt; &apos;link&apos;,</div><div class="line">   &apos;#title&apos; =&gt; t(&apos;Shopping cart&apos;),</div><div class="line">   &apos;#url&apos; =&gt; Url::fromRoute(&apos;cart&apos;),</div><div class="line">   &apos;#options&apos; =&gt; array(</div><div class="line">     &apos;attributes&apos; =&gt; array(</div><div class="line">       &apos;title&apos; =&gt; t(&apos;Shopping cart&apos;),</div><div class="line">     ),</div><div class="line">   ),</div><div class="line"> ),</div><div class="line"> &apos;tray&apos; =&gt; array(</div><div class="line">   &apos;#heading&apos; =&gt; t(&apos;Shopping cart actions&apos;),</div><div class="line">   &apos;shopping_cart&apos; =&gt; array(</div><div class="line">     &apos;#theme&apos; =&gt; &apos;item_list&apos;,</div><div class="line">     &apos;#items&apos; =&gt; array(/* An item list renderable array */),</div><div class="line">   ),</div><div class="line"> ),</div><div class="line"> &apos;#weight&apos; =&gt; 150,</div><div class="line">);</div></pre></td></tr></table></figure></p>
<h2 id="hook-mail"><a href="#hook-mail" class="headerlink" title="hook_mail"></a><a href="https://api.drupal.org/api/drupal/core%21core.api.php/function/hook_mail/8.2.x" target="_blank" rel="external">hook_mail</a></h2><p>根据参数构建mail内容</p>
<h2 id="hook-mail-alter"><a href="#hook-mail-alter" class="headerlink" title="hook_mail_alter"></a><a href="https://api.drupal.org/api/drupal/core%21core.api.php/function/hook_mail_alter/8.2.x" target="_blank" rel="external">hook_mail_alter</a></h2><p>根据条件不发送mail等</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/drupal8/" rel="tag"># drupal8</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/07/create-custom-twig/" rel="next" title="创建自定义模板(Render Array)">
                <i class="fa fa-chevron-left"></i> 创建自定义模板(Render Array)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/13/send-mail/" rel="prev" title="send mail">
                send mail <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="beBetterLy@126.com" />
          <p class="site-author-name" itemprop="name">beBetterLy@126.com</p>
           
              <p class="site-description motion-element" itemprop="description">由drupal8扩展开来</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#理解"><span class="nav-number">1.</span> <span class="nav-text">理解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Blocks"><span class="nav-number">1.1.</span> <span class="nav-text">Blocks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#最小化实现"><span class="nav-number">1.1.1.</span> <span class="nav-text">最小化实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#练习"><span class="nav-number">1.1.2.</span> <span class="nav-text">练习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Create-a-block-which-displays-a-rotating-banner-of-images-Block-configuration"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Create a block which displays a rotating banner of images.(Block configuration)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Create-a-form-block-which-can-send-an-e-mail-to-an-address-provided-in-the-form-block-form"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Create a form block which can send an e-mail to an address provided in the form. (block form)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration-forms"><span class="nav-number">1.2.</span> <span class="nav-text">Configuration forms</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#hooks"><span class="nav-number">2.</span> <span class="nav-text">hooks</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hook-help"><span class="nav-number">2.1.</span> <span class="nav-text">hook_help</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hook-toolbar"><span class="nav-number">2.2.</span> <span class="nav-text">hook_toolbar</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hook-mail"><span class="nav-number">2.3.</span> <span class="nav-text">hook_mail</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hook-mail-alter"><span class="nav-number">2.4.</span> <span class="nav-text">hook_mail_alter</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">beBetterLy@126.com</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

</body>
</html>
